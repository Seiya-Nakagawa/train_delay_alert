# 路線遅延通知システム 要件定義書

## 1. プロジェクト概要

### 1.1. 背景と課題

多くの通勤・通学者は、日常的に利用する交通機関の遅延によって影響を受けている。
遅延情報は各鉄道会社のウェブサイトやアプリで提供されているが、ユーザーが能動的に情報を確認しにいく必要があり、多忙な朝の時間帯などでは確認を忘れたり、情報を見逃したりすることがある。
これにより、駅で足止めされたり、重要な予定に遅刻したりするリスクが生じている。

また、既存のアプリ通知は他の多くの通知に埋もれてしまい、スルーされやすいというユーザーの声もある。

### 1.2. プロジェクトの目的とゴール

本プロジェクトは、上記課題を解決するため、日常的に利用するLINEアプリを通じて、登録した路線の遅延情報を自動で通知するシステムを開発することを目的とする。

これにより、以下のゴール達成を目指す。

* **ゴール1:** ユーザーが自ら情報を探しに行く手間を省き、迅速かつ受動的な情報提供を実現する。
* **ゴール2:** 遅延情報を早期に把握できるようにすることで、代替ルートの検討や出発時間の調整など、ユーザーの円滑な移動を支援する。
* **ゴール3:** 新たなアプリのインストールを不要とし、使い慣れたLINE上で全ての操作（設定から通知受け取りまで）を完結させる。

### 1.3. プロジェクトスコープ（範囲）

* **対象範囲**
  * ユーザーによる通知対象路線の設定（最大5路線）。
  * ユーザーによる通知を受け取る時間帯の設定。
  * 公共交通オープンデータセンターのAPIから定期的に運行情報を取得する。
  * 取得した情報に基づき遅延を判定し、対象ユーザーにLINEで通知する。

* **対象外範囲**
  * 過去の遅延履歴の閲覧機能。
  * 遅延証明書の発行機能。
  * 本システム自体に、代替ルートを提案する機能は持たせない。

## 2. システム構成

本システムは、ユーザーからの設定を受け付ける機能、定期的に外部APIから運行情報を取得・判定する機能、そして判定結果に基づきLINEで通知する機能で構成される。
登録はLINE経由でWebサイト（Github Pages）へのアクセスから実行する。
バックエンドはAWSのサーバーレスサービス（Lambda, EventBridge, DynamoDB, S3, SNS）を活用し、疎結合に連携させる。

## 3. 機能要件

### 3.1. ユーザー設定機能

* LINE公式アカウントを友だち追加することで、路線登録ページへのリッチメニューを表示する機能。
* ユーザーがリッチメニューから遷移したWebサイトを通じて、通知を受けたい路線を設定・変更・削除できる機能。
* 初回の路線登録と併せて、ユーザ登録も実施する。

### 3.2. 運行情報取得・遅延判定機能

* Amazon EventBridgeをトリガーに、15分間隔でAWS Lambdaを起動する機能。
* ユーザーによって登録されている全路線の運行情報を、公共交通オープンデータセンターのAPIから取得する機能。
* 取得した情報から「遅延」や「運転見合わせ」などのステータスを判定する機能。
* 一度通知した遅延について、状況が更新（例: 遅延→復旧）されるまで再通知を抑制する仕組みを持つ。

### 3.3. LINE通知機能

* 遅延判定された路線を登録しているユーザーをデータベース（DynamoDB）から抽出する機能。
* 抽出したユーザーが設定した通知時間帯内であるかを検証する機能。
* 対象ユーザーに対し、LINE Messaging APIを用いて通知メッセージを送信する機能。
* 通知メッセージには「路線名」「遅延状況」「原因」など、APIから取得した情報を含める。

---

## 4. 非機能要件

### 性能

・運行情報APIから遅延情報を取得後、5分以内に該当する全ユーザーへの通知を完了させる。

### 可用性・信頼性

・システムの稼働率を99.0%以上とする。
・運行情報APIへの接続に失敗した場合、間隔を空けて2回までリトライ処理を行う。
・処理の途中で予期せぬエラーが発生した場合、エラー内容をログに記録し、システムが停止しないようにする。

### セキュリティ

・外部APIのキーやアクセストークンは、AWS Secrets ManagerやSystems Manager パラメータストア等の安全な方法で管理し、ソースコード内に直接記述しない。
・各AWSリソースには、処理に必要な最小限の権限（IAMロール）のみを付与する。

### 保守性・運用

・APIからの情報取得、遅延判定、通知処理の各ステップについて、成功・失敗のログをAmazon CloudWatch Logsに出力し、後から追跡可能であること。
・ユーザー登録・更新時には、管理者にその旨をSNSで通知する機能を持つ。
・主要な設定値（APIのエンドポイント、リトライ回数など）は、コード内に直接記述せず、環境変数などで外部から設定・変更が可能であること。

### 互換性

・LINEアプリが動作するiOSおよびAndroidの最新バージョンをサポート対象とする。

---

## 5. 前提・制約事項

* 本プロジェクトで採用する技術スタック（Python, AWS Lambda, Amazon EventBridge, Amazon DynamoDB）で実現可能であることを前提とする。
* 公共交通オープンデータセンターが提供する運行情報APIが、安定して稼働していることを前提とする。
* LINE Messaging APIの仕様変更がないことを前提とする。変更があった場合は、別途対応を検討する。
