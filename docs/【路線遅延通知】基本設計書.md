## 路線遅延通知システム 基本設計書

### 1. 概要
本ドキュメントは、「路線遅延通知システム 要件定義書」に基づき、システムの実現方式を定義する基本設計書です。本設計書は、後続の工程である詳細設計および実装のインプットとなることを目的とします。

### 2. システム構成

#### 2.1. システム構成図
**【路線遅延通知】システム構成図.drawio**を参照

#### 2.2. 利用技術・サービス
| 分類 | 技術・サービス名 | 目的 |
| :--- | :--- | :--- |
| **クラウド** | Amazon Web Services (AWS) | インフラ基盤 |
| **IaC** | Terraform | AWSリソースのコードによる管理 |
| **コンピューティング** | AWS Lambda | ビジネスロジックの実行 |
| **APIエンドポイント**| AWS Lambda Function URL | LINE Webhookのエンドポイント |
| **スケジューリング**| Amazon EventBridge | 定期的なバッチ処理のトリガー |
| **モニタリング** | Amazon CloudWatch | ログ監視、アラーム通知 |
| **データベース** | Amazon DynamoDB | ユーザー設定、運行状況の永続化 |
| **通知** | Amazon SNS | エラー発生時の管理者への通知 |
| **開発言語** | Python | Lambda関数の実装 |
| **外部サービス** | LINE Messaging API | ユーザーとの対話、プッシュ通知 |
| | 公共交通オープンデータセンター API | 鉄道運行情報の取得 |

#### 2.3. 実行環境・ライブラリ

| コンポーネント | 設定項目 | 設定値 | 備考 |
| :--- | :--- | :--- | :--- |
| **AWS Lambda** | ランタイム | Python 3.11 | |
| | Pythonライブラリ | boto3, requests, line-bot-sdk | AWS SDK, HTTP通信, LINE SDK |

### 3. 機能設計

#### 3.1. ユーザー設定機能
*   **処理概要:** LINE PlatformからのWebhookを受け取り、ユーザーの登録、路線や通知時間帯の設定を処理し、結果をDynamoDBに保存する。
*   **トリガー:** AWS Lambda Function URLへのHTTP POSTリクエスト (LINE PlatformからのWebhook)
*   **入力:** LINE PlatformからのWebhookイベントオブジェクト
*   **処理シーケンス:**
    1.  Lambda Function URL経由でWebhookイベントを受信する。
    2.  LINE SDKを用いてリクエストの署名を検証し、不正なリクエストを弾く。
    3.  イベントタイプを判定する。
        *   **FollowEvent (友だち追加):**
            a. イベントからLINEユーザーIDを取得する。
            b. ユーザーテーブルにユーザIDをキーとして新規レコードを作成する。初期設定（空の路線リストなど）を保存する。
            c. ユーザーにウェルカムメッセージと操作説明を返信する。
        *   **MessageEvent (メッセージ受信):**
            a. イベントからLINEユーザーIDとメッセージテキストを取得する。
            b. メッセージ内容を解析し、コマンド（例: 「路線設定」「時間設定」「設定確認」）を判定する。
            c. **路線設定の場合:**
                - ユーザーに路線名を入力するよう促す。
                - 入力された路線名をユーザーテーブルの路線リストに追加/削除する（最大5件）。
                - 更新後の設定内容を返信する。
            d. **時間設定の場合:**
                - ユーザーに通知を受けたい時間帯を入力するよう促す（例: 「7:00-9:00」）。
                - 入力された時間帯をユーザーテーブルに保存する。
                - 更新後の設定内容を返信する。
            e. その他コマンドに応じた処理を行い、結果をLINEで返信する。
*   **出力:** LINE Messaging APIへの応答メッセージ
*   **エラー処理:** 署名検証失敗、DynamoDBへの書き込み失敗時は、CloudWatch Logsにエラーを記録し、ユーザーには汎用的なエラーメッセージを返す。

#### 3.2. 運行情報取得・遅延判定・通知機能
*   **処理概要:** 定期的に全登録路線の運行情報を取得し、遅延が発生していれば対象ユーザーにLINEで通知する。
*   **トリガー:** Amazon EventBridge
*   **入力:** (なし) スケジュールによる自動実行
*   **処理シーケ-ンス:**
    1.  EventBridgeトリガーにより起動。
    2.  ユーザーテーブルをスキャンし、全ユーザーが登録している路線のユニークなリストを作成する。
    3.  各路線について、公共交通オープンデータセンターAPIに問い合わせ、運行情報を取得する。
    4.  取得した情報から、ステータスが「平常運転」以外（例: 「遅延」「運転見合わせ」）の路線を抽出する。
    5.  遅延が発生している路線ごとに、以下の処理を行う。
        a. 電車状況テーブルを参照し、当該路線の現在の遅延情報が前回通知時から変更されているか確認する。
        b. 変更があった場合（新規遅延、情報更新）、通知対象とする。変更がなければ処理をスキップし、重複通知を防ぐ。
        c. ユーザーテーブルをクエリ（GSI利用）し、この遅延路線を登録している全ユーザーを抽出する。
        d. 抽出した各ユーザーについて、現在の時刻がユーザーの通知設定時間帯内であるかを確認する。
        e. 条件に合致するユーザーに対し、LINE Messaging APIのPush Message機能を使い、遅延情報を通知する。
        f. 通知完了後、電車状況テーブルの当該路線のレコードを、最新の遅延情報とタイムスタンプで更新する。
*   **出力:**
    *   (遅延発生時) 対象ユーザーへのLINEプッシュ通知
    *   (内部処理) DynamoDB 電車状況テーブルの更新
*   **エラー処理:**
    *   公共交通APIへの接続失敗時は、設定回数（例: 2回）リトライを実行する。リトライ後も失敗した場合は、CloudWatch Logsにエラーを記録して当該路線の処理をスキップする。
    *   DynamoDBへのアクセス失敗、LINE APIへの通知失敗時は、CloudWatch Logsにエラーを記録し、処理を続行する。

---

### 4. データ設計

#### 4.1. DynamoDBテーブル設計

*   **Usersテーブル**
    *   **役割:** ユーザーごとの設定情報を管理する。
    *   **テーブル定義:**
        | 項目名 | データ型 | 説明 | キー |
        | :--- | :--- | :--- | :--- |
        | `line_user_id` | String | LINEから取得する一意のユーザーID | パーティションキー |
        | `registered_routes` | List\<String> | ユーザーが登録した路線名のリスト (例: `["JR山手線", "東京メトロ丸ノ内線"]`) | |
        | `notification_start_time` | String | 通知を開始する時間 (HH:MM形式, 例: "07:00") | |
        | `notification_end_time` | String | 通知を終了する時間 (HH:MM形式, 例: "09:00") | |
        | `created_at` | String | ユーザー登録日時 (ISO 8601形式) | |
        | `updated_at` | String | 最終更新日時 (ISO 8601形式) | |
    *   **グローバルセカンダリインデックス (GSI):** 路線名からユーザーを検索するために設定を検討（今回は`Scan`で実装するが、ユーザー数増加時には必須）。

*   **TrainStatusテーブル**
    *   **役割:** 各路線の最新の遅延状況を記録し、重複通知を防止する。
    *   **テーブル定義:**
        | 項目名 | データ型 | 説明 | キー |
        | :--- | :--- | :--- | :--- |
        | `route_id` | String | 路線を一意に識別するID (例: `odpt.Railway:JR-East.Yamanote`) | パーティションキー |
        | `last_status` | String | 最後に検知した運行状況 (例: "遅延") | |
        | `train_information` | String | 最後に検知した遅延情報テキスト | |
        | `last_notified_at` | String | 最後に通知を実行した日時 (ISO 8601形式) | |

#### 4.2. API連携データ設計
*   **公共交通オープンデータセンター API (レスポンス例)**
    *   フォーマット: JSON
    *   主要な利用項目: `odpt:railway` (路線名), `odpt:trainInformationStatus` (運行状況), `odpt:trainInformationText` (詳細テキスト)
*   **LINE Messaging API (Push Message Body例)**
    *   フォーマット: JSON
    *   内容:
    ```json
    {
      "to": "Uxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
      "messages":[
          {
              "type":"text",
              "text":"【運行情報】\n路線: JR山手線\n状況: 遅延\n詳細: ○○駅での線路内立入の影響で、一部列車に15分程度の遅れが出ています。"
          }
      ]
    }
    ```

### 5. 非機能要件設計

| 項目 | 設計内容 |
| :--- | :--- |
| **セキュリティ** | 1. LINE Messaging APIのチャネルシークレット、アクセストークン、および公共交通APIのアクセストークンは、AWS Systems Manager パラメータストアまたはAWS Secrets Managerで管理し、Lambda実行時に動的に取得する。 2. 各LambdaにアタッチするIAMロールは、必要最小限の権限（特定のDynamoDBテーブルへのRead/Write、特定のCloudWatch Log GroupへのWriteなど）のみを許可する。 |
| **保守性・運用** | 1. APIエンドポイント、DynamoDBテーブル名などの設定値は、Lambdaの環境変数で管理し、コードと分離する。 2. LambdaのログはAmazon CloudWatch LogsにJSON形式で出力し、リクエストID、エラーレベル、メッセージを構造化して記録する。 3. 重大なエラー（DynamoDBアクセス不可など）が発生した場合、CloudWatch Alarmを設定し、Amazon SNS経由で管理者に通知する仕組みを構築する。 |